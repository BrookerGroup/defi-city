# DeFi City Builder - Product Requirements Document

## Overview

**DeFi City** à¹€à¸›à¹‡à¸™à¹€à¸à¸¡ City Builder à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸à¸²à¸£à¸šà¸£à¸´à¸«à¸²à¸£à¹€à¸‡à¸´à¸™à¸šà¸™ DeFi à¹€à¸›à¹‡à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‡à¹ˆà¸²à¸¢à¹à¸¥à¸°à¸ªà¸™à¸¸à¸ à¹‚à¸”à¸¢à¹à¸›à¸¥à¸‡ DeFi concepts à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ game mechanics à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢

### Core Concept

| Game Concept         | DeFi Reality        |
| -------------------- | ------------------- |
| à¹€à¸¡à¸·à¸­à¸‡ (City)         | Portfolio à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ |
| à¸­à¸²à¸„à¸²à¸£ (Buildings)    | DeFi Strategies     |
| à¸—à¸£à¸±à¸à¸¢à¸²à¸à¸£ (Resources) | Real Crypto Assets  |
| à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡              | à¸šà¸£à¸´à¸«à¸²à¸£à¹€à¸‡à¸´à¸™à¸šà¸™ DeFi   |

---

## Target Users

- **Web3 Beginners**: à¸œà¸¹à¹‰à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ DeFi à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸°à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸¢à¸±à¸‡à¹„à¸‡
- **Passive Investors**: à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ yield à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰ DeFi protocols à¸—à¸µà¹ˆà¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™
- **Gamers**: à¸Šà¸­à¸šà¹€à¸à¸¡ City Builder à¹à¸¥à¸°à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ earn real crypto

---

## User Flow

### Step 1: Connect Wallet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ® DeFi City                         â”‚
â”‚                                                         â”‚
â”‚              Welcome to DeFi City!                      â”‚
â”‚                                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚   ğŸ¦Š Connect with MetaMask  â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚   ğŸ“§ Connect with Email     â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚   ğŸ”‘ Connect with Google    â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Technical:**

- à¹ƒà¸Šà¹‰ Privy/Dynamic SDK à¸ªà¸³à¸«à¸£à¸±à¸š authentication
- à¸£à¸­à¸‡à¸£à¸±à¸š EOA (MetaMask) à¹à¸¥à¸° Social Login
- à¹€à¸à¹‡à¸š session à¹ƒà¸™ localStorage

### Step 2: Create Smart Wallet (à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚         ğŸ—ï¸ Creating Your Smart Wallet...               â”‚
â”‚                                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  75%      â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                         â”‚
â”‚         âœ… Deploying wallet contract                   â”‚
â”‚         âœ… Setting up permissions                       â”‚
â”‚         â³ Finalizing...                               â”‚
â”‚                                                         â”‚
â”‚         Your wallet: 0x1234...5678                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Technical:**

```javascript
// Check if user has Smart Wallet
const existingWallet = await factory.getWallet(userAddress);

if (existingWallet === ADDRESS_ZERO) {
  // Create new Smart Wallet
  const tx = await factory.createWallet(userAddress);
  await tx.wait();

  // Get new wallet address
  const newWallet = await factory.getWallet(userAddress);
  console.log("Smart Wallet created:", newWallet);
}
```

**Flow:**

```
User connects EOA (MetaMask/Social)
         â”‚
         â–¼
Check SmartWalletFactory.getWallet(user)
         â”‚
         â”œâ”€â”€ Wallet exists? â†’ Go to Step 3
         â”‚
         â””â”€â”€ No wallet? â†’ Deploy new SmartWallet
                              â”‚
                              â–¼
                         Save to localStorage
                              â”‚
                              â–¼
                         Go to Step 3
```

### Step 3: Start Playing DeFi (Game HTML)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° 2500    â—‡ 1.50    ğŸ’ 500           ğŸ”— Connected    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚     â¬†ï¸                        ğŸŒ²         ğŸŒ²            â”‚
â”‚   â¬…ï¸ ğŸ§ â¡ï¸         ğŸ›ï¸                                  â”‚
â”‚     â¬‡ï¸          Town Hall      ğŸŒ²     ğŸŒ²               â”‚
â”‚                                                         â”‚
â”‚        ğŸŒ¾              â›ï¸                               â”‚
â”‚    Yield Farm       LP Mine          ğŸŒ²                â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ›ï¸ Town Hall] [ğŸŒ¾ Farm] [â›ï¸ Mine] [ğŸª Shop] [ğŸ°]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Actions in Game:**

| Game Action      | Smart Contract Call                     | Result              |
| ---------------- | --------------------------------------- | ------------------- |
| à¸ªà¸£à¹‰à¸²à¸‡ Yield Farm | `wallet.depositToAave(USDC, 100)`       | à¹„à¸”à¹‰ aUSDC           |
| à¸ªà¸£à¹‰à¸²à¸‡ LP Mine    | `wallet.addLiquidity(ETH, USDC, ...)`   | à¹„à¸”à¹‰ LP NFT          |
| à¹€à¸à¹‡à¸š Yield       | `wallet.withdrawFromAave(USDC, amount)` | à¹„à¸”à¹‰ USDC + interest |
| Collect Fees     | `wallet.collectFees(tokenId)`           | à¹„à¸”à¹‰ trading fees    |

**Complete User Journey:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Step 1  â”‚    â”‚    Step 2    â”‚    â”‚      Step 3      â”‚   â”‚
â”‚   â”‚ Connect  â”‚â”€â”€â”€â–¶â”‚ Create Smart â”‚â”€â”€â”€â–¶â”‚   Play Game      â”‚   â”‚
â”‚   â”‚ Wallet   â”‚    â”‚   Wallet     â”‚    â”‚   (DeFi)         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                 â”‚                     â”‚              â”‚
â”‚        â–¼                 â–¼                     â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ MetaMask â”‚    â”‚SmartWallet   â”‚    â”‚ â€¢ Build farms    â”‚   â”‚
â”‚   â”‚ or       â”‚    â”‚Factory       â”‚    â”‚ â€¢ Deposit crypto â”‚   â”‚
â”‚   â”‚ Social   â”‚    â”‚.createWallet()â”‚   â”‚ â€¢ Earn yields    â”‚   â”‚
â”‚   â”‚ Login    â”‚    â”‚              â”‚    â”‚ â€¢ Withdraw profitâ”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Deposit & Withdraw Flow

**Deposit (à¹€à¸•à¸´à¸¡à¹€à¸‡à¸´à¸™à¹€à¸‚à¹‰à¸²à¹€à¸à¸¡):**

```
User's MetaMask/CEX
        â”‚
        â”‚ Transfer USDC/ETH
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Smart Wallet   â”‚  â† User's game wallet
â”‚  (0x1234...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸²à¸„à¸²à¸£ = Deposit to Protocol
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Aave/Uniswap   â”‚
â”‚  (get aUSDC/LP) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Withdraw (à¸–à¸­à¸™à¹€à¸‡à¸´à¸™à¸­à¸­à¸):**

```
Game: Click "Withdraw" on building
        â”‚
        â–¼
SmartWallet.withdrawFromAave() / removeLiquidity()
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Smart Wallet   â”‚  â† USDC/ETH returned here
â”‚  (0x1234...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ User clicks "Send to MetaMask"
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User's EOA     â”‚
â”‚  or CEX address â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Features

### 1. Smart Wallet System

#### 1.1 Wallet Creation

- à¹ƒà¸Šà¹‰ **Account Abstraction (ERC-4337)** à¸ªà¸£à¹‰à¸²à¸‡ Smart Wallet
- Social Login (Google, Apple, Email) - à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¸³ seed phrase
- Gasless transactions (Paymaster sponsored)

#### 1.2 Deposit Flow

```
User â†’ Deposit USDC/ETH â†’ Smart Wallet â†’ Game Portfolio
```

#### 1.3 Withdrawal Flow

```
Game Portfolio â†’ Smart Wallet â†’ User's EOA/CEX
```

---

### 2. Building Types (DeFi Strategies)

#### 2.1 Yield Farm (Aave Integration)

| Attribute    | Value               |
| ------------ | ------------------- |
| Strategy     | USDC â†’ Aave Lending |
| Expected APY | 3-8%                |
| Risk Level   | Low                 |
| Min Deposit  | 10 USDC             |

**Smart Contract Flow:**

```solidity
// Deposit
USDC.approve(aavePool, amount);
aavePool.supply(USDC, amount, smartWallet, 0);

// Withdraw
aavePool.withdraw(USDC, amount, smartWallet);
```

#### 2.2 Staking Camp (Lido/Rocket Pool)

| Attribute    | Value            |
| ------------ | ---------------- |
| Strategy     | ETH â†’ stETH/rETH |
| Expected APY | 3-5%             |
| Risk Level   | Low-Medium       |
| Min Deposit  | 0.01 ETH         |

#### 2.3 LP Mine (Uniswap Integration)

| Attribute    | Value                     |
| ------------ | ------------------------- |
| Strategy     | ETH-USDC LP on Uniswap V3 |
| Expected APY | 5-20% (variable)          |
| Risk Level   | Medium-High               |
| Min Deposit  | 50 USDC equivalent        |

**Smart Contract Flow:**

```solidity
// Add Liquidity
uniswapRouter.addLiquidity(
    tokenA, tokenB,
    amountA, amountB,
    minA, minB,
    smartWallet,
    deadline
);

// Remove Liquidity
uniswapRouter.removeLiquidity(...);
```

#### 2.4 Castle (Governance Vault)

| Attribute   | Value                                |
| ----------- | ------------------------------------ |
| Strategy    | veToken Locking (e.g., veCRV, veBAL) |
| Boost       | +25% yields on other buildings       |
| Lock Period | 90 days                              |
| Min Deposit | 1000 USDC equivalent                 |

#### 2.5 Shop (DEX Aggregator)

| Attribute    | Value                      |
| ------------ | -------------------------- |
| Strategy     | Swap fees rebate           |
| Expected APY | Variable (based on volume) |
| Risk Level   | Low                        |

---

### 3. Resource System

#### 3.1 In-Game Resources

| Resource   | Real Asset | Usage              |
| ---------- | ---------- | ------------------ |
| Gold Coins | USDC/USDT  | Build, upgrade     |
| Ethereum   | ETH        | Premium buildings  |
| LP Tokens  | Uniswap LP | Special structures |

#### 3.2 Resource Generation

- Buildings generate resources based on **real DeFi yields**
- UI shows both game value and real USD value
- Auto-compound option available

---

### 4. Game Mechanics

#### 4.1 City Progression

```
Level 1: Town Hall + 3 Yield Farms
Level 2: Unlock Staking Camp
Level 3: Unlock LP Mine
Level 4: Unlock Castle
Level 5: Unlock Advanced Strategies
```

#### 4.2 Risk Management

- **Walls**: Insurance protocols (Nexus Mutual)
- **Guard Towers**: Stop-loss automation
- **Moat**: Diversification bonus

#### 4.3 Social Features

- Visit friends' cities
- Guild system (shared vaults)
- Leaderboards (by TVL, APY, city level)

---

## Building Progression (Starting Buildings)

### Initial Buildings by Level

| Level | TVL Required | Unlocked Buildings  | Protocol        |
| ----- | ------------ | ------------------- | --------------- |
| 1     | $0           | ğŸ›ï¸ Town Hall (auto) | -               |
| 1     | $0           | ğŸŒ¾ Yield Farm       | Aave (USDC)     |
| 2     | $100         | ğŸªµ Staking Camp     | Lido (ETH)      |
| 3     | $500         | â›ï¸ LP Mine          | Uniswap V3      |
| 4     | $2,000       | ğŸª Shop             | DEX Aggregator  |
| 5     | $5,000       | ğŸ° Castle           | Governance Lock |

### Starting State (New Player)

```mermaid
flowchart TD
    subgraph START["ğŸ® New Player Starts"]
        A[Connect Wallet] --> B[Create Smart Wallet]
        B --> C[Deposit USDC/ETH]
    end

    subgraph INITIAL["ğŸ“¦ Initial City - Level 1"]
        D["ğŸ›ï¸ Town Hall<br/>(Auto-placed, FREE)"]
        E["ğŸŒ¾ Yield Farm<br/>(Unlocked, 10 USDC min)"]
    end

    C --> D
    C --> E

    subgraph PROGRESS["ğŸ“ˆ Progression"]
        F["Deposit $100+ â†’ Level 2<br/>Unlock: ğŸªµ Staking Camp"]
        G["Deposit $500+ â†’ Level 3<br/>Unlock: â›ï¸ LP Mine"]
        H["Deposit $2000+ â†’ Level 4<br/>Unlock: ğŸª Shop"]
        I["Deposit $5000+ â†’ Level 5<br/>Unlock: ğŸ° Castle"]
    end

    E --> F --> G --> H --> I
```

### Building Limits per Level

```mermaid
graph LR
    subgraph L1["Level 1"]
        A1["ğŸ›ï¸ Town Hall: 1"]
        A2["ğŸŒ¾ Yield Farm: 3"]
    end

    subgraph L2["Level 2"]
        B1["ğŸŒ¾ Yield Farm: 5"]
        B2["ğŸªµ Staking Camp: 2"]
    end

    subgraph L3["Level 3"]
        C1["ğŸŒ¾ Yield Farm: 10"]
        C2["ğŸªµ Staking Camp: 5"]
        C3["â›ï¸ LP Mine: 3"]
    end

    subgraph L5["Level 5"]
        D1["All Buildings: Unlimited"]
        D2["ğŸ° Castle: 1"]
    end

    L1 --> L2 --> L3 --> L5
```

---

## System Diagrams (Mermaid)

### Overall System Architecture

```mermaid
flowchart TB
    subgraph Frontend["ğŸ–¥ï¸ Frontend Layer"]
        UI["Game UI<br/>(PixiJS)"]
        Wallet["Wallet UI<br/>(Privy)"]
        Portfolio["Portfolio View"]

        UI --> App
        Wallet --> App
        Portfolio --> App
        App["Next.js App<br/>(wagmi + viem)"]
    end

    subgraph Blockchain["â›“ï¸ Blockchain Layer"]
        Factory["SmartWalletFactory<br/>(Deploy + Registry)"]

        WalletA["Smart Wallet A"]
        WalletB["Smart Wallet B"]
        WalletC["Smart Wallet C"]

        Factory --> WalletA
        Factory --> WalletB
        Factory --> WalletC

        subgraph Protocols["DeFi Protocols"]
            Aave["Aave V3"]
            Lido["Lido"]
            Uniswap["Uniswap V3"]
        end

        WalletA --> Protocols
        WalletB --> Protocols
        WalletC --> Protocols
    end

    App --> Factory
```

### Token Flow Diagram

```mermaid
flowchart TD
    subgraph User["ğŸ‘¤ User"]
        EOA["EOA Wallet<br/>(MetaMask)"]
    end

    subgraph SmartWallet["ğŸ“± Smart Wallet"]
        Balance["Balances:<br/>â€¢ USDC: 1000<br/>â€¢ ETH: 0.5<br/>â€¢ aUSDC: 500<br/>â€¢ LP NFT #123"]
    end

    subgraph DeFi["ğŸ¦ DeFi Protocols"]
        Aave["Aave Pool<br/>USDC â†’ aUSDC<br/>APY: 5%"]
        Uniswap["Uniswap V3<br/>ETH + USDC â†’ LP NFT<br/>APY: 10-20%"]
    end

    EOA -->|"â‘  Transfer USDC/ETH"| SmartWallet
    SmartWallet -->|"â‘¡ depositToAave()"| Aave
    SmartWallet -->|"â‘¢ addLiquidity()"| Uniswap

    Aave -->|"aUSDC"| SmartWallet
    Uniswap -->|"LP NFT"| SmartWallet

    SmartWallet -->|"â‘£ Withdraw"| EOA
```

### Game State Machine

```mermaid
stateDiagram-v2
    [*] --> Connect: Open App

    Connect --> CreateWallet: No Wallet
    Connect --> Loading: Has Wallet
    CreateWallet --> Loading: Wallet Created

    Loading --> Playing: Balances Loaded

    state Playing {
        [*] --> Idle
        Idle --> Building: Select Building
        Building --> Depositing: Confirm Build
        Depositing --> Idle: Tx Success
        Depositing --> Idle: Tx Failed

        Idle --> Withdrawing: Click Withdraw
        Withdrawing --> Idle: Tx Complete
    }

    Playing --> Disconnect: Disconnect Wallet
    Disconnect --> [*]
```

### Building â†’ Protocol Mapping

```mermaid
flowchart LR
    subgraph Game["ğŸ® GAME WORLD"]
        TH["ğŸ›ï¸ Town Hall"]
        YF["ğŸŒ¾ Yield Farm"]
        SC["ğŸªµ Staking Camp"]
        LP["â›ï¸ LP Mine"]
        CA["ğŸ° Castle"]
        SH["ğŸª Shop"]
    end

    subgraph DeFi["ğŸ’° DEFI WORLD"]
        SW["Smart Wallet Balance"]
        AAVE["Aave V3<br/>USDC Lending<br/>APY: 5%"]
        LIDO["Lido<br/>ETH Staking<br/>APY: 4%"]
        UNI["Uniswap V3<br/>LP Position<br/>APY: 10-20%"]
        GOV["Governance Vault<br/>Lock 90d<br/>Boost: +25%"]
        DEX["DEX Aggregator<br/>1inch / 0x"]
    end

    TH -.->|"Portfolio Overview"| SW
    YF -->|"Supply USDC"| AAVE
    SC -->|"Stake ETH"| LIDO
    LP -->|"Add Liquidity"| UNI
    CA -->|"Lock Tokens"| GOV
    SH -->|"Swap"| DEX
```

### Sequence: Build Yield Farm

```mermaid
sequenceDiagram
    participant User
    participant GameUI
    participant SmartWallet
    participant Aave

    User->>GameUI: Click "Build Yield Farm"
    GameUI->>User: Show deposit modal
    User->>GameUI: Enter 100 USDC
    GameUI->>SmartWallet: depositToAave(USDC, 100)

    SmartWallet->>Aave: approve(100)
    SmartWallet->>Aave: supply(USDC, 100)
    Aave-->>SmartWallet: aUSDC (100)

    SmartWallet-->>GameUI: Tx confirmed
    GameUI-->>User: ğŸŒ¾ Farm appears on map!
```

### Database Schema (Off-chain)

```mermaid
erDiagram
    USERS ||--o{ CITIES : owns
    CITIES ||--o{ BUILDINGS : contains
    CITIES ||--o{ TRANSACTIONS : has

    USERS {
        int id PK
        string wallet_address
        string smart_wallet
        datetime created_at
        datetime last_login
    }

    CITIES {
        int id PK
        int user_id FK
        string name
        int level
        json layout
        datetime created_at
    }

    BUILDINGS {
        int id PK
        int city_id FK
        string type
        int x_pos
        int y_pos
        decimal deposited
        datetime created_at
    }

    TRANSACTIONS {
        int id PK
        int city_id FK
        string type
        decimal amount
        string tx_hash
        string status
        datetime created_at
    }
```

### Multi-Chain Architecture (Future)

```mermaid
flowchart TB
    subgraph Frontend["DeFi City Frontend"]
        App["Next.js App"]
    end

    subgraph Chains["Supported Chains"]
        subgraph Base["Base (Primary)"]
            B1["â€¢ Low gas"]
            B2["â€¢ Fast tx"]
            B3["â€¢ Aave V3"]
            B4["â€¢ Uniswap V3"]
        end

        subgraph Arbitrum["Arbitrum"]
            A1["â€¢ More DeFi"]
            A2["â€¢ GMX, Camelot"]
            A3["â€¢ Aave V3"]
        end

        subgraph Ethereum["Ethereum (Premium)"]
            E1["â€¢ Main Aave"]
            E2["â€¢ Main Uniswap"]
            E3["â€¢ Highest TVL"]
        end
    end

    subgraph Bridge["Bridge (Future)"]
        LZ["LayerZero / CCIP"]
    end

    App --> Base
    App --> Arbitrum
    App --> Ethereum

    Base <--> LZ
    Arbitrum <--> LZ
    Ethereum <--> LZ
```

### User Onboarding Flow

```mermaid
journey
    title User Onboarding Journey
    section Connect
      Open DeFi City: 5: User
      Click Connect Wallet: 4: User
      Choose MetaMask/Social: 4: User
    section Setup
      Create Smart Wallet: 3: System
      View Empty City: 4: User
    section First Deposit
      Transfer USDC to Wallet: 3: User
      Build First Yield Farm: 5: User
      See Farm on Map: 5: User
    section Earning
      Watch APY accumulate: 5: User
      Level up to 2: 5: System
      Unlock Staking Camp: 5: User
```

---

## Technical Architecture

### 5.1 Smart Contract Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DeFi City Protocol                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚   User A              User B              User C         â”‚
â”‚      â”‚                   â”‚                   â”‚           â”‚
â”‚      â–¼                   â–¼                   â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Smart  â”‚         â”‚ Smart  â”‚         â”‚ Smart  â”‚       â”‚
â”‚  â”‚Wallet Aâ”‚         â”‚Wallet Bâ”‚         â”‚Wallet Câ”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚â€¢ aUSDC â”‚         â”‚â€¢ aUSDC â”‚         â”‚â€¢ stETH â”‚       â”‚
â”‚  â”‚â€¢ stETH â”‚         â”‚â€¢ LP NFTâ”‚         â”‚â€¢ aUSDC â”‚       â”‚
â”‚  â”‚â€¢ USDC  â”‚         â”‚â€¢ ETH   â”‚         â”‚â€¢ LP NFTâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜       â”‚
â”‚       â”‚                  â”‚                  â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚           SmartWalletFactory                   â”‚      â”‚
â”‚  â”‚  (Deploy Smart Wallets + Registry)             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                          â”‚                               â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â–¼                  â–¼                  â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Aave   â”‚       â”‚ Uniswap  â”‚       â”‚  Lido   â”‚      â”‚
â”‚  â”‚  Pool   â”‚       â”‚   V3     â”‚       â”‚         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**

- à¹à¸•à¹ˆà¸¥à¸° User à¸¡à¸µ Smart Wallet à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡
- Assets (aUSDC, stETH, LP NFT) à¹€à¸à¹‡à¸šà¹ƒà¸™ Smart Wallet à¹‚à¸”à¸¢à¸•à¸£à¸‡
- à¹„à¸¡à¹ˆà¸¡à¸µ VaultManager - User à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡ 100%
- SmartWalletFactory à¹ƒà¸Šà¹‰ deploy wallet à¹ƒà¸«à¸¡à¹ˆà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™

### 5.2 Key Contracts

#### SmartWalletFactory.sol

```solidity
contract SmartWalletFactory {
    mapping(address => address) public wallets; // owner => wallet

    event WalletCreated(address indexed owner, address indexed wallet);

    function createWallet(address owner) external returns (address) {
        SmartWallet wallet = new SmartWallet(owner, entryPoint);
        wallets[owner] = address(wallet);
        emit WalletCreated(owner, address(wallet));
        return address(wallet);
    }

    function getWallet(address owner) external view returns (address) {
        return wallets[owner];
    }
}
```

#### SmartWallet.sol

```solidity
contract SmartWallet is ERC4337Account {
    address public owner;
    IPool public constant AAVE_POOL = IPool(0x...);
    ISwapRouter public constant UNISWAP_ROUTER = ISwapRouter(0x...);

    // ============ Aave Functions ============

    function depositToAave(address token, uint256 amount) external onlyOwner {
        IERC20(token).approve(address(AAVE_POOL), amount);
        AAVE_POOL.supply(token, amount, address(this), 0);
        // aToken is sent directly to this wallet
    }

    function withdrawFromAave(address token, uint256 amount) external onlyOwner {
        AAVE_POOL.withdraw(token, amount, address(this));
    }

    function getAaveBalance(address aToken) external view returns (uint256) {
        return IERC20(aToken).balanceOf(address(this));
    }

    // ============ Uniswap Functions ============

    function addLiquidity(
        address token0,
        address token1,
        uint256 amount0,
        uint256 amount1,
        int24 tickLower,
        int24 tickUpper
    ) external onlyOwner returns (uint256 tokenId) {
        // Approve tokens
        IERC20(token0).approve(address(positionManager), amount0);
        IERC20(token1).approve(address(positionManager), amount1);

        // Mint LP position - NFT sent to this wallet
        (tokenId,,,) = positionManager.mint(MintParams({
            token0: token0,
            token1: token1,
            fee: 3000,
            tickLower: tickLower,
            tickUpper: tickUpper,
            amount0Desired: amount0,
            amount1Desired: amount1,
            amount0Min: 0,
            amount1Min: 0,
            recipient: address(this),
            deadline: block.timestamp
        }));
    }

    function removeLiquidity(uint256 tokenId) external onlyOwner {
        // Decrease liquidity and collect tokens back to wallet
        positionManager.decreaseLiquidity(...);
        positionManager.collect(...);
    }

    function collectFees(uint256 tokenId) external onlyOwner {
        positionManager.collect(CollectParams({
            tokenId: tokenId,
            recipient: address(this),
            amount0Max: type(uint128).max,
            amount1Max: type(uint128).max
        }));
    }

    // ============ Generic Execute ============

    function execute(
        address target,
        uint256 value,
        bytes calldata data
    ) external onlyOwner returns (bytes memory) {
        (bool success, bytes memory result) = target.call{value: value}(data);
        require(success, "Execution failed");
        return result;
    }
}
```

#### GameRegistry.sol (Optional - for leaderboards/social)

```solidity
contract GameRegistry {
    struct CityStats {
        uint256 level;
        uint256 totalDeposited;
        uint256 buildingCount;
        uint256 lastUpdate;
    }

    mapping(address => CityStats) public cities;

    // Called by frontend to update stats (optional, for social features)
    function updateStats(address wallet, CityStats calldata stats) external {
        // Verify caller owns the wallet
        require(SmartWallet(wallet).owner() == msg.sender, "Not owner");
        cities[wallet] = stats;
    }

    function getLeaderboard() external view returns (address[] memory, uint256[] memory) {
        // Return top cities by TVL
    }
}

### 5.3 Frontend Stack

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeFi City Frontend â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Next.js 14 (App Router) â”‚
â”‚ â”œâ”€â”€ PixiJS (Game Rendering) â”‚
â”‚ â”œâ”€â”€ wagmi + viem (Web3) â”‚
â”‚ â”œâ”€â”€ Privy/Dynamic (Smart Wallet) â”‚
â”‚ â””â”€â”€ TanStack Query (Data Fetching) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## Integrations

### 6.1 Aave V3 (Primary Lending)
- **Networks**: Ethereum, Arbitrum, Base
- **Assets**: USDC, USDT, DAI, ETH, WBTC
- **Features**: Supply, Borrow, Flash Loans

### 6.2 Uniswap V3 (Primary DEX)
- **Networks**: Ethereum, Arbitrum, Base, Polygon
- **Features**:
  - Concentrated Liquidity Positions
  - Auto-rebalancing ranges
  - Fee tier optimization (0.05%, 0.3%, 1%)

### 6.3 Future Integrations
- **Lido**: ETH Liquid Staking
- **Curve**: Stablecoin pools
- **Compound**: Additional lending
- **GMX**: Perpetual trading strategies
- **Yearn**: Vault strategies

---

## Security

### 7.1 Smart Contract Security
- [ ] Multiple audits (Certik, Trail of Bits)
- [ ] Formal verification for core contracts
- [ ] Time-locked upgrades (48h delay)
- [ ] Emergency pause functionality
- [ ] Rate limiting on withdrawals

### 7.2 User Security
- [ ] 2FA for large withdrawals
- [ ] Spending limits
- [ ] Whitelist addresses
- [ ] Session keys with expiration

---

## Roadmap

### Phase 1: MVP (Q1 2025)
- [ ] Smart Wallet creation
- [ ] Basic city UI (isometric view)
- [ ] Aave integration (USDC lending)
- [ ] Single building type (Yield Farm)
- [ ] Testnet deployment (Base Sepolia)

### Phase 2: Core Game (Q2 2025)
- [ ] Uniswap LP integration
- [ ] Multiple building types
- [ ] City progression system
- [ ] Mainnet deployment (Base)

### Phase 3: Social (Q3 2025)
- [ ] Friend system
- [ ] City visiting
- [ ] Guild/DAO features
- [ ] Leaderboards

### Phase 4: Advanced (Q4 2025)
- [ ] Cross-chain cities
- [ ] Advanced strategies
- [ ] Mobile app
- [ ] SDK for third-party strategies

---

## Metrics & KPIs

| Metric | Target (6 months) |
|--------|-------------------|
| Total Users | 10,000 |
| TVL | $5M |
| Daily Active Users | 2,000 |
| Average Portfolio Size | $500 |
| User Retention (30d) | 40% |

---

## Revenue Model

1. **Performance Fee**: 10% of profits generated
2. **Premium Features**: Advanced buildings, analytics
3. **NFT Buildings**: Limited edition structures
4. **Protocol Partnerships**: Referral fees from integrated protocols

---

## Team Requirements

- Smart Contract Engineers (2)
- Frontend/Game Developers (2)
- Product Designer (1)
- Security Engineer (1)
- Community Manager (1)

---

## Appendix

### A. Glossary
- **TVL**: Total Value Locked
- **APY**: Annual Percentage Yield
- **LP**: Liquidity Provider
- **Smart Wallet**: ERC-4337 Account Abstraction wallet

### B. References
- [Aave V3 Documentation](https://docs.aave.com/)
- [Uniswap V3 Documentation](https://docs.uniswap.org/)
- [ERC-4337 Specification](https://eips.ethereum.org/EIPS/eip-4337)
- [Privy Documentation](https://docs.privy.io/)

---

*Last Updated: January 2025*
*Version: 1.0*
```
